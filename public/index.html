<!doctype html><html lang=en dir=auto><head><meta name=generator content="Hugo 0.135.0"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CodoC</title>
<meta name=keywords content="Blog,Portfolio,PaperMod"><meta name=description content="CodoC / Code documentation"><meta name=author content="Me"><link rel=canonical href=http://localhost:1313/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.54405a410796490bc874ab6181fac9b675753cc2b91375d8f882566459eca428.css integrity="sha256-VEBaQQeWSQvIdKthgfrJtnV1PMK5E3XY+IJWZFnspCg=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/images/books.png><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=http://localhost:1313/index.xml><link rel=alternate type=application/json href=http://localhost:1313/index.json><link rel=alternate hreflang=en href=http://localhost:1313/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="CodoC"><meta property="og:description" content="CodoC / Code documentation"><meta property="og:type" content="website"><meta property="og:url" content="http://localhost:1313/"><meta property="og:image" content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="og:site_name" content="CodoC"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="CodoC"><meta name=twitter:description content="CodoC / Code documentation"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"CodoC","url":"http://localhost:1313/","description":"CodoC / Code documentation","thumbnailUrl":"http://localhost:1313/images/books.png","sameAs":[]}</script></head><body class="list dark" id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="CodoC (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>CodoC</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=http://localhost:1313/categories/ title=categories><span>categories</span></a></li><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class="first-entry home-info"><header class=entry-header><h1></h1></header><div class=entry-content>Cheatsheet bank</div><footer class=entry-footer><div class=social-icons></div></footer></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Clickhouse useful queries</h2></header><div class=entry-content><p>Get information about replicas select database, table, is_leader, is_readonly, total_replicas, active_replicas, replica_is_active, replica_name from cluster('{cluster}', system.replicas); Sync Clickhouse metadata with Zookeeper system restart replica ON cluster '{cluster}' &lt;DB>.&lt;TABLE> system restore replica ON cluster '{cluster}' &lt;DB>.&lt;TABLE> Sync a replica with others system sync replica on cluster '{cluster}' &lt;DB>.&lt;TABLE> system sync database replica &lt;DB>; Check replication status SELECT database, table, is_leader, is_readonly, is_session_expired, future_parts, parts_to_check, columns_version, queue_size, inserts_in_queue, merges_in_queue, log_max_index, log_pointer, total_replicas, active_replicas FROM system.replicas WHERE is_readonly OR is_session_expired OR future_parts > 20 OR parts_to_check > 10 OR queue_size > 20 OR inserts_in_queue > 10 OR log_max_index - log_pointer > 10 OR total_replicas &lt; 2 OR active_replicas &lt; total_replicas Tables status select parts.*, columns.compressed_size, columns.uncompressed_size, columns.compression_ratio, columns.compression_percentage from ( select table, formatReadableSize(sum(data_uncompressed_bytes)) AS uncompressed_size, formatReadableSize(sum(data_compressed_bytes)) AS compressed_size, round(sum(data_compressed_bytes) / sum(data_uncompressed_bytes), 3) AS compression_ratio, round((100 - (sum(data_compressed_bytes) * 100) / sum(data_uncompressed_bytes)), 3) AS compression_percentage from system.columns group by table ) columns right join ( select table, sum(rows) as rows, max(modification_time) as latest_modification, formatReadableSize(sum(bytes)) as disk_size, formatReadableSize(sum(primary_key_bytes_in_memory)) as primary_keys_size, any(engine) as engine, sum(bytes) as bytes_size from system.parts where active group by database, table ) parts on columns.table = parts.table order by parts.bytes_size desc; Columns size SELECT database, table, formatReadableSize(sum(data_compressed_bytes) AS size) AS compressed, formatReadableSize(sum(data_uncompressed_bytes) AS usize) AS uncompressed, round(usize / size, 2) AS compr_rate, sum(rows) AS rows, count() AS part_count FROM system.parts WHERE (active = 1) AND (database LIKE '%') AND (table LIKE '%') GROUP BY database, table ORDER BY size DESC; Check corrupted data set check_query_single_value_result = 0; -------------------------------- check table &lt;DB>.&lt;TABLE>; -------------------------------- CHECK ALL TABLES FORMAT PrettyCompactMonoBlock SETTINGS check_query_single_value_result = 0 Zookeeper connections status select * from system.zookeeper_connection; select * from system.zookeeper where path='/clickhouse/'; From remote replica select count() from remote('&lt;REPLICA_NAME>',&lt;DB>.&lt;TABLE>,'&lt;USER>','&lt;PASS>'); Attach and Detach tables detach table &lt;DB>.&lt;TABLE> on cluster '{cluster}' sync; attach table &lt;DB>.&lt;TABLE> on cluster '{cluster}'; To find parts and detached parts select * from system.detached_parts; ------------------------------- select partition_id,name FROM system.parts WHERE database='&lt;DB>'; ------------------------------- select substr(table, 1, 22),partition AS prt,name,part_type,path FROM system.parts WHERE database = '&lt;DB>' ORDER BY table ASC, partition ASC, name ASC ------------------------------- SELECT *, concat('alter table ',database,'.',table,' drop detached part ''',a.name,''' settings allow_drop_detached=1;') as drop FROM system.detached_parts a ALL LEFT JOIN (SELECT database, table, partition_id, name, active, min_block_number, max_block_number FROM system.parts WHERE active ) b USING (database, table, partition_id) WHERE a.min_block_number >= b.min_block_number AND a.max_block_number &lt;= b.max_block_number ORDER BY table, min_block_number, max_block_number ------------------------------- select partition,name,active,bytes_on_disk as diskSize,database,table,path from system.parts; ------------------------------- SELECT database, table, reason, count() FROM system.detached_parts GROUP BY database, table, reason ORDER BY database ASC, table ASC, reason ASC -- Active parts in cluster SELECT database, table, partition, sum(rows) AS rows, count() AS part_count FROM system.parts WHERE (active = 1) AND (table LIKE '%') AND (database LIKE '%') GROUP BY database, table, partition ORDER BY part_count DESC limit 20 Attach and detach part or portition to table alter table &lt;DB>.&lt;TABLE> attach part 'b0deaa35da556bc0c_1824_1824_0'; alter table &lt;DB>.&lt;TABLE> attach partition '876f020b03f4d84bb_646168_646168_0' | ALL ; alter table &lt;DB>.&lt;TABLE> detach part '7a16aac8d0949ac37_4264_4264_0'; alter table &lt;DB>.&lt;TABLE> detach partition '7a16aac4906b58c37'; Part logs in Clickhouse SELECT event_time, event_type, part_name, exception FROM system.part_log where part_name='7a16aac8d09bc37_2420_2420_0' Find expensive queries SELECT type, event_time, initial_query_id, query_id, formatReadableSize(memory_usage) AS memory, ProfileEvents.Values[indexOf(ProfileEvents.Names, 'UserTimeMicroseconds')] AS userCPU, ProfileEvents.Values[indexOf(ProfileEvents.Names, 'SystemTimeMicroseconds')] AS systemCPU, normalizedQueryHash(query) AS normalized_query_hash FROM system.query_log ORDER BY memory_usage DESC LIMIT 10; ------------------------------- SELECT query FROM system.query_log WHERE initial_query_id = '43801b2a-7aeb-4cfc-8171-59a97d8bddf7' ------------------------------- SELECT hostname(), type, event_time, initial_query_id, query_id, formatReadableSize(memory_usage) AS memory, ProfileEvents.Values[indexOf(ProfileEvents.Names, 'UserTimeMicroseconds')] AS userCPU, ProfileEvents.Values[indexOf(ProfileEvents.Names, 'SystemTimeMicroseconds')] AS systemCPU, normalizedQueryHash(query) AS normalized_query_hash FROM cluster('{cluster}', system.query_log) order by memory_usage desc limit 10; Debug queries SELECT * FROM system.errors; SELECT * FROM system.events LIMIT 5; SELECT * FROM system.parts_columns LIMIT 1 FORMAT Vertical; SELECT * FROM viewIfPermitted(SELECT message FROM system.warnings ELSE null('message String')) SELECT query,query_start_time FROM system.query_log WHERE query_start_time > '2024-09-30 01:00:00' and query_start_time &lt; '2024-09-30 23:59:00' New queries ALTER TABLE your_table_name DROP PARTITION 'partition_id' WHERE condition; SELECT uniq(*)/count(*) FROM invoice_items; RELOAD ASYNCHRONOUS METRICS [ON CLUSTER cluster_name] SYSTEM FLUSH LOGS [ON CLUSTER cluster_name] SHUTDOWN SYSTEM RELOAD USERS [ON CLUSTER cluster_name] SYSTEM STOP DISTRIBUTED SENDS [db.]&lt;distributed_table_name> [ON CLUSTER cluster_name] SYSTEM FLUSH DISTRIBUTED [db.]&lt;distributed_table_name> [ON CLUSTER cluster_name] [SETTINGS ...] SYSTEM STOP LISTEN [ON CLUSTER cluster_name] [QUERIES ALL | QUERIES DEFAULT | QUERIES CUSTOM | TCP | TCP WITH PROXY | TCP SECURE | HTTP | HTTPS | MYSQL | GRPC | POSTGRESQL | PROMETHEUS | CUSTOM 'protocol'] SYSTEM START LISTEN [ON CLUSTER cluster_name] [QUERIES ALL | QUERIES DEFAULT | QUERIES CUSTOM | TCP | TCP WITH PROXY | TCP SECURE | HTTP | HTTPS | MYSQL | GRPC | POSTGRESQL | PROMETHEUS | CUSTOM 'protocol'] SYSTEM REFRESH VIEW [db.]name ALTER TABLE table_name [ON CLUSTER cluster] FREEZE [PARTITION partition_expr] [WITH NAME 'backup_name'] Useful links altinity-kb-useful-queries
...</p></div><footer class=entry-footer><span title='2020-09-16 00:00:00 +0000 UTC'>September 16, 2020</span>&nbsp;路&nbsp;4 min&nbsp;路&nbsp;760 words&nbsp;路&nbsp;Me</footer><a class=entry-link aria-label="post link to Clickhouse useful queries" href=http://localhost:1313/posts/clickhouse_useful_queries/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Gitlab runner for local environment</h2></header><div class=entry-content><p>Run Gitlab runner for local CI/CD { docker run --entrypoint bash --rm -w $PWD -v $PWD:$PWD -v /var/run/docker.sock:/var/run/docker.sock gitlab/gitlab-runner:latest -c 'git config --global --add safe.directory "*";gitlab-runner exec docker build' }</p></div><footer class=entry-footer><span title='2020-09-16 00:00:00 +0000 UTC'>September 16, 2020</span>&nbsp;路&nbsp;1 min&nbsp;路&nbsp;30 words&nbsp;路&nbsp;Me</footer><a class=entry-link aria-label="post link to Gitlab runner for local environment" href=http://localhost:1313/posts/gitlab/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Ceph OSD Management</h2></header><div class=entry-content><p>Ceph Object Storage Daemons (OSDs) are the heart and soul of the Ceph storage platform. Each OSD manages a local device and together they provide the distributed storage. Rook will automate creation and management of OSDs to hide the complexity based on the desired state in the CephCluster CR as much as possible. This guide will walk through some of the scenarios to configure OSDs where more configuration may be required.
...</p></div><footer class=entry-footer><span title='2020-09-15 11:30:03 +0000 +0000'>September 15, 2020</span>&nbsp;路&nbsp;7 min&nbsp;路&nbsp;1454 words&nbsp;路&nbsp;Me</footer><a class=entry-link aria-label="post link to Ceph OSD Management" href=http://localhost:1313/posts/ceph/></a></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>CodoC</a></span> 路
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>